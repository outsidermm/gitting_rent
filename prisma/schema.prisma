// Smart Bond Return — Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum LeaseStatus {
    PENDING_ESCROW    // Lease created; tenant has not yet locked funds
    ESCROWED          // Tenant locked XRP in XRPL escrow
    MOVE_OUT_PENDING  // Tenant submitted move-out evidence
    APPROVED          // Notary approved; escrow released
}

model Lease {
    id String @id @default(cuid())

    // Property details
    propertyAddress String

    // XRPL wallet addresses — any party can use any address
    landlordAddress String
    tenantAddress   String
    notaryAddress   String

    // Bond amount stored as string to avoid floating-point loss
    bondAmountDrops String // XRP drops (1 XRP = 1,000,000 drops)

    // Baseline condition set by landlord
    baselineCondition String
    baselinePhotoUrls String[]

    // XRPL escrow fields (populated after EscrowCreate is confirmed)
    escrowSequence     Int?    // Sequence number of the EscrowCreate tx
    escrowOwnerAddress String? // Account that issued EscrowCreate (tenant)

    // Crypto condition for notary-controlled release
    // Stored as hex strings
    escrowCondition  String? // PREIMAGE-SHA-256 condition (public)
    escrowFulfillment String? // Preimage (kept secret until release)

    status   LeaseStatus @default(PENDING_ESCROW)
    evidence Evidence?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([landlordAddress])
    @@index([tenantAddress])
    @@index([notaryAddress])
}

model Evidence {
    id      String @id @default(cuid())
    leaseId String @unique
    lease   Lease  @relation(fields: [leaseId], references: [id], onDelete: Cascade)

    exitCondition String
    exitPhotoUrls String[]

    submittedAt DateTime @default(now())
}
